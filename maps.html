<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Indoor Map</title>
  <link rel="stylesheet" href="maps-style.css" />
</head>
<body>

  <h1>Indoor Map Test</h1>

  <button id="start-scan">Start Beacon Scan</button>
  <div id="status">Not connected</div>

  <div id="map-container" style="display: none;">
    <img id="floor-map" src="assets/floor_plan_enhanced.png" alt="Floor Map" />
  </div>

  <script>
    const beacon1 = "fb:01:4b:54:27:3e"; // Beacon 1
    const beacon2 = "cf:15:06:d2:b2:21"; // Beacon 2
    const mapContainer = document.getElementById("map-container");
    const status = document.getElementById("status");

    let currentNearest = null;
    let rssiMap = {};

    document.getElementById("start-scan").addEventListener("click", async () => {
      if (!navigator.bluetooth || !navigator.bluetooth.requestLEScan) {
        alert("Web Bluetooth API not supported on this device/browser.");
        return;
      }

      status.textContent = "Requesting scan permission...";
      
      try {
        await navigator.bluetooth.requestLEScan({ acceptAllAdvertisements: true });

        status.textContent = "Scanning... bring your beacons close.";

        navigator.bluetooth.addEventListener("advertisementreceived", event => {
          const mac = event.device.id.toLowerCase();
          const rssi = event.rssi;

          if (mac === beacon1 || mac === beacon2) {
            rssiMap[mac] = rssi;

            let nearest = null;
            if (rssiMap[beacon1] != null && rssiMap[beacon2] != null) {
              nearest = rssiMap[beacon1] > rssiMap[beacon2] ? beacon1 : beacon2;
            } else {
              nearest = rssiMap[beacon1] != null ? beacon1 : beacon2;
            }

            if (nearest !== currentNearest) {
              currentNearest = nearest;
              status.textContent = `Nearest: ${nearest.toUpperCase()} (RSSI ${rssiMap[nearest]})`;

              if (nearest === beacon1) {
                mapContainer.style.display = "block";
              } else if (nearest === beacon2) {
                mapContainer.style.display = "none";
              }
            }
          }
        });

      } catch (error) {
        console.error("Scan error:", error);
        status.textContent = "Scan failed: " + error.message;
      }
    });
  </script>

</body>
</html>
